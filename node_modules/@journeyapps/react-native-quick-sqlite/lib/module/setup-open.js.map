{"version":3,"names":["ConcurrentLockType","enhanceQueryResult","DBListenerManagerInternal","TransactionFinalizer","DEFAULT_READ_CONNECTIONS","requestIdCounter","getRequestId","LockCallbacks","proxy","closeContextLock","dbName","id","releaseLock","global","onLockContextIsAvailable","lockId","setImmediate","record","timeout","clearTimeout","callback","_contextId","execute","sql","args","result","executeInContext","ex","console","error","setupOpen","QuickSQLite","open","options","numReadConnections","listenerManager","requestLock","type","hooks","Promise","resolve","reject","context","_hooks$lockAcquired","lockAcquired","call","res","_hooks$lockReleased","lockReleased","timeoutMs","setTimeout","Error","readLock","READ","writeLock","WRITE","flushUpdates","wrapTransaction","defaultFinalizer","COMMIT","finalized","finalizedStatement","action","commit","rollback","wrapExecute","method","params","ROLLBACK","ex2","close","readTransaction","writeTransaction","delete","location","executeBatch","commands","attach","dbNameToAttach","alias","detach","loadFile","registerUpdateHook","registerListener","rawTableChange","registerTablesChangedHook","tablesUpdated"],"sources":["setup-open.ts"],"sourcesContent":["import {\n  ISQLite,\n  ConcurrentLockType,\n  QuickSQLiteConnection,\n  ContextLockID,\n  LockContext,\n  LockOptions,\n  TransactionContext,\n  UpdateCallback,\n  SQLBatchTuple,\n  OpenOptions,\n  QueryResult\n} from './types';\n\nimport { enhanceQueryResult } from './utils';\nimport { DBListenerManagerInternal } from './DBListenerManager';\nimport { LockHooks } from './lock-hooks';\n\ntype LockCallbackRecord = {\n  callback: (context: LockContext) => Promise<any>;\n  timeout?: NodeJS.Timeout;\n};\n\nenum TransactionFinalizer {\n  COMMIT = 'commit',\n  ROLLBACK = 'rollback'\n}\n\nconst DEFAULT_READ_CONNECTIONS = 4;\n\n// A incrementing integer ID for tracking lock requests\nlet requestIdCounter = 1;\n\nconst getRequestId = () => {\n  requestIdCounter++;\n  return `${requestIdCounter}`;\n};\n\nconst LockCallbacks: Record<ContextLockID, LockCallbackRecord> = {};\nlet proxy: ISQLite;\n\n/**\n * Closes the context in JS and C++\n */\nfunction closeContextLock(dbName: string, id: ContextLockID) {\n  delete LockCallbacks[id];\n\n  // This is configured by the setupOpen function\n  proxy.releaseLock(dbName, id);\n}\n\n/**\n * JS callback to trigger queued callbacks when a lock context is available.\n * Declared on the global scope so that C++ can call it.\n * @param lockId\n * @returns\n */\nglobal.onLockContextIsAvailable = async (dbName: string, lockId: ContextLockID) => {\n  // Don't hold C++ bridge side up waiting to complete\n  setImmediate(async () => {\n    try {\n      const record = LockCallbacks[lockId];\n      if (record?.timeout) {\n        clearTimeout(record.timeout);\n      }\n      await record?.callback({\n        // @ts-expect-error This is not part of the public interface, but is used internally\n        _contextId: lockId,\n        execute: async (sql: string, args?: any[]) => {\n          const result = await proxy.executeInContext(dbName, lockId, sql, args);\n          enhanceQueryResult(result);\n          return result;\n        }\n      });\n    } catch (ex) {\n      console.error(ex);\n    }\n  });\n};\n\n/**\n * Generates the entry point for opening concurrent connections\n * @param proxy\n * @returns\n */\nexport function setupOpen(QuickSQLite: ISQLite) {\n  // Allow the Global callbacks to close lock contexts\n  proxy = QuickSQLite;\n\n  return {\n    /**\n     * Opens a SQLite DB connection.\n     * By default opens DB in WAL mode with 4 Read connections and a single\n     * write connection\n     */\n    open: (dbName: string, options: OpenOptions = {}): QuickSQLiteConnection => {\n      // Opens the connection\n      QuickSQLite.open(dbName, {\n        ...options,\n        numReadConnections: options?.numReadConnections ?? DEFAULT_READ_CONNECTIONS\n      });\n\n      const listenerManager = new DBListenerManagerInternal({ dbName });\n\n      /**\n       * Wraps lock requests and their callbacks in order to resolve the lock\n       * request with the callback result once triggered from the connection pool.\n       */\n      const requestLock = <T>(\n        type: ConcurrentLockType,\n        callback: (context: LockContext) => Promise<T>,\n        options?: LockOptions,\n        hooks?: LockHooks\n      ): Promise<T> => {\n        const id = getRequestId();\n        // Wrap the callback in a promise that will resolve to the callback result\n        return new Promise<T>((resolve, reject) => {\n          // Add callback to the queue for timing\n          const record = (LockCallbacks[id] = {\n            callback: async (context: LockContext) => {\n              try {\n                await hooks?.lockAcquired?.();\n                const res = await callback(context);\n\n                closeContextLock(dbName, id);\n                resolve(res);\n              } catch (ex) {\n                closeContextLock(dbName, id);\n                reject(ex);\n              } finally {\n                hooks?.lockReleased?.();\n              }\n            }\n          } as LockCallbackRecord);\n\n          try {\n            QuickSQLite.requestLock(dbName, id, type);\n            const timeout = options?.timeoutMs;\n            if (timeout) {\n              record.timeout = setTimeout(() => {\n                // The callback won't be executed\n                delete LockCallbacks[id];\n                reject(new Error(`Lock request timed out after ${timeout}ms`));\n              }, timeout);\n            }\n          } catch (ex) {\n            // Remove callback from the queue\n            delete LockCallbacks[id];\n            reject(ex);\n          }\n        });\n      };\n\n      const readLock = <T>(callback: (context: LockContext) => Promise<T>, options?: LockOptions): Promise<T> =>\n        requestLock(ConcurrentLockType.READ, callback, options);\n\n      const writeLock = <T>(callback: (context: LockContext) => Promise<T>, options?: LockOptions): Promise<T> =>\n        requestLock(ConcurrentLockType.WRITE, callback, options, {\n          lockReleased: async () => {\n            // flush updates once a write lock has been released\n            listenerManager.flushUpdates();\n          }\n        });\n\n      const wrapTransaction = async <T>(\n        context: LockContext,\n        callback: (context: TransactionContext) => Promise<T>,\n        defaultFinalizer: TransactionFinalizer = TransactionFinalizer.COMMIT\n      ) => {\n        await context.execute('BEGIN TRANSACTION');\n        let finalized = false;\n\n        const finalizedStatement =\n          <T>(action: () => T): (() => T) =>\n          () => {\n            if (finalized) {\n              return;\n            }\n            finalized = true;\n            return action();\n          };\n\n        const commit = finalizedStatement(async () => context.execute('COMMIT'));\n\n        const rollback = finalizedStatement(async () => context.execute('ROLLBACK'));\n\n        const wrapExecute =\n          <T>(\n            method: (sql: string, params?: any[]) => Promise<QueryResult>\n          ): ((sql: string, params?: any[]) => Promise<QueryResult>) =>\n          async (sql: string, params?: any[]) => {\n            if (finalized) {\n              throw new Error(`Cannot execute in transaction after it has been finalized with commit/rollback.`);\n            }\n            return method(sql, params);\n          };\n\n        try {\n          const res = await callback({\n            ...context,\n            commit,\n            rollback,\n            execute: wrapExecute(context.execute)\n          });\n          switch (defaultFinalizer) {\n            case TransactionFinalizer.COMMIT:\n              await commit();\n              break;\n            case TransactionFinalizer.ROLLBACK:\n              await rollback();\n              break;\n          }\n          return res;\n        } catch (ex) {\n          try {\n            await rollback();\n          } catch (ex2) {\n            // In rare cases, a rollback may fail.\n            // Safe to ignore.\n          }\n          throw ex;\n        }\n      };\n\n      // Return the concurrent connection object\n      return {\n        close: () => QuickSQLite.close(dbName),\n        execute: (sql: string, args?: any[]) => writeLock((context) => context.execute(sql, args)),\n        readLock,\n        readTransaction: async <T>(callback: (context: TransactionContext) => Promise<T>, options?: LockOptions) =>\n          readLock((context) => wrapTransaction(context, callback)),\n        writeLock,\n        writeTransaction: async <T>(callback: (context: TransactionContext) => Promise<T>, options?: LockOptions) =>\n          writeLock((context) => wrapTransaction(context, callback, TransactionFinalizer.COMMIT), options),\n        delete: () => QuickSQLite.delete(dbName, options?.location),\n        executeBatch: (commands: SQLBatchTuple[]) =>\n          writeLock((context) => QuickSQLite.executeBatch(dbName, commands, (context as any)._contextId)),\n        attach: (dbNameToAttach: string, alias: string, location?: string) =>\n          QuickSQLite.attach(dbName, dbNameToAttach, alias, location),\n        detach: (alias: string) => QuickSQLite.detach(dbName, alias),\n        loadFile: (location: string) =>\n          writeLock((context) => QuickSQLite.loadFile(dbName, location, (context as any)._contextId)),\n        listenerManager,\n        registerUpdateHook: (callback: UpdateCallback) =>\n          listenerManager.registerListener({ rawTableChange: callback }),\n        registerTablesChangedHook: (callback) => listenerManager.registerListener({ tablesUpdated: callback })\n      };\n    }\n  };\n}\n"],"mappings":"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","ignoreList":[]}